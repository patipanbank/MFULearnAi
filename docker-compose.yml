services:
  db:
    image: mongo
    container_name: mfulearnai_db
    ports:
      - 27017:27017
    volumes:
      - data:/data/db
    environment:
      - MONGO_INITDB_ROOT_USERNAME=root
      - MONGO_INITDB_ROOT_PASSWORD=1234
    restart: always
    networks:
      - mfulearnai

  redis:
    image: redis:alpine
    container_name: mfulearnai_redis
    ports:
      - "6379:6379"
    volumes:
      - redis:/data
    networks:
      - mfulearnai
    restart: unless-stopped

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    env_file:
      - .env
    ports:
      - "5000:5000"
    volumes:
      - ./backend:/app
    environment:
      # Override specific values that need to be different in Docker
      - MONGODB_URI=mongodb://root:1234@db:27017/mfu_chatbot?authSource=admin
      - CHROMA_URL=http://chroma:8000
      - REDIS_URL=redis://redis:6379
      # All other environment variables will be loaded from .env file
    depends_on:
      - chroma
      - db
      - redis
    networks:
      - mfulearnai
    restart: unless-stopped
    dns:
      - 8.8.8.8
      - 1.1.1.1

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=${FRONTEND_URL:-https://mfulearnai.mfu.ac.th}
        - VITE_WS_URL=wss://mfulearnai.mfu.ac.th/ws
    # This service is now only for building the frontend assets.
    # It will build and then exit. The assets are shared via the volume.
    volumes:
      - frontend-dist:/app/dist
    # No need for ports or restart policy for a build-only service
    networks:
      - mfulearnai

  nginx:
    build: 
      context: ./nginx
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      # Environment-specific nginx configuration
      - SERVER_NAME=${NGINX_SERVER_NAME:-localhost}
      - BACKEND_HOST=backend
      - BACKEND_PORT=5000
      - FRONTEND_HOST=frontend
      - FRONTEND_PORT=80
      - SSL_CERT_PATH=/etc/nginx/ssl/cert.pem
      - SSL_KEY_PATH=/etc/nginx/ssl/key.pem
      - LOG_LEVEL=${NGINX_LOG_LEVEL:-warn}
      - CORS_ORIGIN=${NGINX_CORS_ORIGIN:-*}
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
      # Mount the static assets built by the frontend service
      - frontend-dist:/var/www/frontend
    depends_on:
      - frontend # Nginx will wait for the frontend build to complete
      - backend
    networks:
      - mfulearnai
    restart: unless-stopped

  chroma:
    image: chromadb/chroma
    container_name: chromadb
    ports:
      - "8000:8000"
    environment:
      - ANONYMIZED_TELEMETRY=False
      - CHROMA_SERVER_CORS_ALLOW_ORIGINS=["*"]
    volumes:
      - chroma:/chroma/chroma
    networks:
      - mfulearnai
    restart: unless-stopped


volumes:
  data:
  redis:
  chroma:
  # Define the volume that will hold the built frontend assets
  frontend-dist:

networks:
  mfulearnai:
    driver: bridge