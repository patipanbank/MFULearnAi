services:
  db:
    image: mongo
    container_name: mfulearnai_db
    ports:
      - 27017:27017
    volumes:
      - data:/data/db
    environment:
      - MONGO_INITDB_ROOT_USERNAME=root
      - MONGO_INITDB_ROOT_PASSWORD=1234
    restart: always
    networks:
      - mfulearnai

  redis:
    image: redis:alpine
    container_name: mfulearnai_redis
    ports:
      - "6379:6379"
    volumes:
      - redis:/data
    networks:
      - mfulearnai
    restart: unless-stopped

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      # Override specific values that need to be different in Docker
      - MONGODB_URI=mongodb://root:1234@db:27017/mfu_chatbot?authSource=admin
      - CHROMA_URL=http://chroma:8000
      - REDIS_URL=redis://redis:6379
      # All other environment variables will be loaded from .env file
    depends_on:
      - chroma
      - db
      - redis
    networks:
      - mfulearnai
    restart: unless-stopped
    dns:
      - 8.8.8.8
      - 1.1.1.1

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=${FRONTEND_URL:-https://mfulearnai.mfu.ac.th}/api
        - VITE_WS_URL=wss://mfulearnai.mfu.ac.th/ws
    env_file:
      - .env
    volumes:
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
    networks:
      - mfulearnai
    restart: unless-stopped

  nginx:
    build: 
      context: ./nginx
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      # Environment-specific nginx configuration
      - SERVER_NAME=${NGINX_SERVER_NAME:-localhost}
      - BACKEND_HOST=backend
      - BACKEND_PORT=5000
      - FRONTEND_HOST=frontend
      - FRONTEND_PORT=80
      - SSL_CERT_PATH=/etc/nginx/ssl/cert.pem
      - SSL_KEY_PATH=/etc/nginx/ssl/key.pem
      - LOG_LEVEL=${NGINX_LOG_LEVEL:-warn}
      - CORS_ORIGIN=${NGINX_CORS_ORIGIN:-*}
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - 80:80
      - 443:443
    depends_on:
      - frontend
      - backend
    networks:
      - mfulearnai
    restart: unless-stopped

  chroma:
    image: chromadb/chroma
    container_name: chromadb
    ports:
      - "8000:8000"
    environment:
      - ANONYMIZED_TELEMETRY=False
      - CHROMA_SERVER_CORS_ALLOW_ORIGINS=["*"]
    volumes:
      - chroma:/chroma/chroma
    networks:
      - mfulearnai
    restart: unless-stopped


volumes:
  data:
  redis:
  chroma:

networks:
  mfulearnai:
    driver: bridge